import{_ as t,o as n,c as o,Q as a,k as s,a as e}from"./chunks/framework.980cae92.js";const A=JSON.parse('{"title":"Constraints","description":"","frontmatter":{"outline":[2,3]},"headers":[],"relativePath":"docs/language/constraints.md","filePath":"docs/language/constraints.md"}'),i={name:"docs/language/constraints.md"},r=a(`<h1 id="constraints" tabindex="-1">Constraints <a class="header-anchor" href="#constraints" aria-label="Permalink to &quot;Constraints&quot;">​</a></h1><div class="subtitle">Controlled, type-safe LLM generation with guarantees.</div><p>LMQL allows you to specify constraints on the language model output. This is valuable in scripted prompting, to ensure the model output stops at the desired point, but also allows you to guide the model during decoding.</p><p>This chapter provides an overview of the set of currently available constraints and a brief description of their semantics. Beyond that, LMQL constraint support is modular and can also be extended, as discussed in more detail in <a href="./constraints/custom-constraints.html">Custom Constraints</a>.</p><h2 id="supported-constraints" tabindex="-1">Supported Constraints <a class="header-anchor" href="#supported-constraints" aria-label="Permalink to &quot;Supported Constraints&quot;">​</a></h2><h3 id="stopping-phrases" tabindex="-1">Stopping Phrases <a class="header-anchor" href="#stopping-phrases" aria-label="Permalink to &quot;Stopping Phrases&quot;">​</a></h3><p>For many prompts, scripted prompts in particular, it is important to ensure that the model stops decoding once a certain word or symbol is reached. To do so, LMQL supports the <code>STOPS_AT</code> and <code>STOPS_BEFORE</code> constraint. They take two arguments, the first is the name of the variable to which the model output is assigned, the second is the stopping phrase.</p><p>In the example below we use stopping conditions to ensure that as soon as the model predicts the newline character <code>\\n</code> the decoding of the current <code>THING</code> variable ends, and the query program continues execution.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="hljs"><code><span class="line"><span class="hljs-string">&quot;A list of things not to forget when going to the sea (not travelling): \\n&quot;</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
   <span class="hljs-string">&quot;-<span class="hljs-placeholder">[THING]</span>&quot;</span> <span class="hljs-keyword">where</span> STOPS_AT(THING, <span class="hljs-string">&quot;\\n&quot;</span>)
</span></code></pre></div>`,9),l=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`A list of things not to forget when going to the sea (not travelling): 
- [THING|Sunscreen]
- [THING|Beach towels]
- [THING|Swimsuit]
- [THING|Sunglasses]
- [THING|Hat]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"73",text:"A","pd-insertion-point":"true"},[e(`A list of things not to forget when going to the sea (not travelling): 
- `),s("span",{"pd-shadow-id":"75","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"76",text:"T",class:"promptdown-var-name"},"THING"),e("Sunscreen")]),e(`
- `),s("span",{"pd-shadow-id":"81","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"82",text:"T",class:"promptdown-var-name"},"THING"),e("Beach towels")]),e(`
- `),s("span",{"pd-shadow-id":"87","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"88",text:"T",class:"promptdown-var-name"},"THING"),e("Swimsuit")]),e(`
- `),s("span",{"pd-shadow-id":"93","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"94",text:"T",class:"promptdown-var-name"},"THING"),e("Sunglasses")]),e(`
- `),s("span",{"pd-shadow-id":"99","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"100",text:"T",class:"promptdown-var-name"},"THING"),e("Hat")]),e(`
`)])])],-1),p=a(`<div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If multiple variables in the query have the same name, the constraint is applied to all of them.</p></div><h3 id="number-type-constraints" tabindex="-1">Number Type Constraints <a class="header-anchor" href="#number-type-constraints" aria-label="Permalink to &quot;Number Type Constraints&quot;">​</a></h3><p>The data type of a generated variable can also be constrained. For example, we can constrain a variable to be a string, encoding an integer by using <code>INT</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="hljs"><code><span class="line"><span class="hljs-string">&quot;A number: <span class="hljs-placeholder">[N]</span>&quot;</span> <span class="hljs-keyword">where</span> INT(N)
</span></code></pre></div>`,4),d=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`A number: [N|2]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"106",text:"A","pd-insertion-point":"true"},[e("A number: "),s("span",{"pd-shadow-id":"108","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"109",text:"N",class:"promptdown-var-name"},"N"),e("2")]),e(`
`)])])],-1),c=a(`<p>This enforces that the model cannot generate tokens that do not correspond to an integer.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>LMQL currently only supports integer constraints. However, support for floating point numbers and other types is planned for future releases.</p></div><h3 id="choice-from-set" tabindex="-1">Choice From Set <a class="header-anchor" href="#choice-from-set" aria-label="Permalink to &quot;Choice From Set&quot;">​</a></h3><p>LMQL allows to specify that a variable should be a choice from a set of possible values. This can be rephrased as the variable being within a set of possible values, i.e. <code>THING in set([&quot;Volleyball&quot;, &quot;Sunscreen&quot;, &quot;Bathing Suite&quot;])</code> in the following example</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="hljs"><code><span class="line"><span class="hljs-keyword">sample</span>(temperature=<span class="hljs-number">0.8</span>)
   <span class="hljs-string">&quot;A list of things not to forget when going to the sea (not travelling): \\n&quot;</span>
   <span class="hljs-string">&quot;- Sunglasses \\n&quot;</span>
   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
      <span class="hljs-string">&quot;- <span class="hljs-placeholder">[THING]</span> \\n&quot;</span>
<span class="hljs-keyword">from</span>
   <span class="hljs-string">&#39;openai/text-ada-001&#39;</span>
<span class="hljs-keyword">where</span>
   THING <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>([<span class="hljs-string">&quot;Volleyball&quot;</span>, <span class="hljs-string">&quot;Sunscreen&quot;</span>, <span class="hljs-string">&quot;Bathing Suite&quot;</span>])

</span></code></pre></div>`,5),h=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`A list of things not to forget when going to the sea (not travelling):
- [THING|Sunglasses]
- [THING|Sunscreen]
- [THING|Volleyball]
- [THING|Sunscreen]
- [THING|Sunscreen]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"115",text:"A","pd-insertion-point":"true"},[e(`A list of things not to forget when going to the sea (not travelling):
- `),s("span",{"pd-shadow-id":"117","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"118",text:"T",class:"promptdown-var-name"},"THING"),e("Sunglasses")]),e(`
- `),s("span",{"pd-shadow-id":"123","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"124",text:"T",class:"promptdown-var-name"},"THING"),e("Sunscreen")]),e(`
- `),s("span",{"pd-shadow-id":"129","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"130",text:"T",class:"promptdown-var-name"},"THING"),e("Volleyball")]),e(`
- `),s("span",{"pd-shadow-id":"135","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"136",text:"T",class:"promptdown-var-name"},"THING"),e("Sunscreen")]),e(`
- `),s("span",{"pd-shadow-id":"141","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"142",text:"T",class:"promptdown-var-name"},"THING"),e("Sunscreen")]),e(`
`)])])],-1),u=a(`<h3 id="character-length" tabindex="-1">Character Length <a class="header-anchor" href="#character-length" aria-label="Permalink to &quot;Character Length&quot;">​</a></h3><p>Similar to Python, the <code>len</code> function can be used to refer to the length of a variable and can thus be used to add constraints on it&#39;s length on a character level.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="hljs"><code><span class="line"><span class="hljs-keyword">argmax</span>
   <span class="hljs-string">&quot;Hello <span class="hljs-placeholder">[NAME]</span>&quot;</span>
<span class="hljs-keyword">from</span>
   <span class="hljs-string">&#39;openai/text-ada-001&#39;</span>
<span class="hljs-keyword">where</span>
    <span class="hljs-built_in">len</span>(NAME) &lt; <span class="hljs-number">10</span>

</span></code></pre></div>`,3),m=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`Hello [NAME| ⏎
⏎
I am in]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"148",text:"H","pd-insertion-point":"true"},[e("Hello "),s("span",{"pd-shadow-id":"150","pd-instant":"false",text:"",class:"promptdown-var color-purple"},[s("span",{"pd-shadow-id":"151",text:"N",class:"promptdown-var-name"},"NAME"),e(` ⏎
⏎
I am in`)]),e(`
`)])])],-1),g=a(`<h3 id="token-length" tabindex="-1">Token Length <a class="header-anchor" href="#token-length" aria-label="Permalink to &quot;Token Length&quot;">​</a></h3><p>Next to character-level length constraints, you can also specify constraints on the token length of a variable. This is useful if you want to ensure that the model does not generate too many tokens for a given variable. For instance, in the following example, we constrain the length of the variable <code>THING</code> to be at most 3 tokens:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="hljs"><code><span class="line"><span class="hljs-string">&quot;Greet the user in four different ways: <span class="hljs-placeholder">[GREETINGS]</span>&quot;</span> \\
   <span class="hljs-keyword">where</span> <span class="hljs-built_in">len</span>(TOKENS(GREETINGS)) &lt; <span class="hljs-number">10</span>
</span></code></pre></div>`,3),w=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`Greet the user in four different ways: [GREETINGS|⏎
⏎
1. Hello there! It's nice]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"157",text:"G","pd-insertion-point":"true"},[e("Greet the user in four different ways: "),s("span",{"pd-shadow-id":"159","pd-instant":"false",text:"",class:"promptdown-var color-lightorange"},[s("span",{"pd-shadow-id":"160",text:"G",class:"promptdown-var-name"},"GREETINGS"),e(`⏎
⏎
1. Hello there It's nice`)]),e(`
`)])])],-1),_=a(`<p>Similar to character length constraints, the <code>len</code> function can also be used to refer to the number of <code>TOKENS(GREETINGS)</code>. However, now, length is measured in tokens, not characters. The exact resulting character length of the output thus depends on the tokenization of the model, however.</p><p>Token length constraints are cheaper to enforce than character length constraints, as they can be implemented as simple length checks on the tokenized output, rather than the more expensive character-level length checks, which require detokenization and masking.</p><h3 id="regex-constraints-preview" tabindex="-1">Regex Constraints <span class="badge">Preview</span> <a class="header-anchor" href="#regex-constraints-preview" aria-label="Permalink to &quot;Regex Constraints &lt;span class=&quot;badge&quot;&gt;Preview&lt;/span&gt;&quot;">​</a></h3><p>LMQL also supports <code>REGEX</code> constraints. This allows you to enforce a regular expression during generation of a variable.</p><p>As a simple example, consider the following snippet:</p><div class="language-lmql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lmql</span><pre class="hljs"><code><span class="line"><span class="hljs-string">&quot;It&#39;s the last day of June so today is <span class="hljs-placeholder">[DATE]</span>&quot;</span> \\
   <span class="hljs-keyword">where</span> REGEX(DATE, r<span class="hljs-string">&quot;<span class="hljs-placeholder">[<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]</span><span class="hljs-subst">{<span class="hljs-number">2</span>}</span>/<span class="hljs-placeholder">[<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]</span><span class="hljs-subst">{<span class="hljs-number">2</span>}</span>&quot;</span>)
</span></code></pre></div>`,6),v=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`It's the last day of June so today is [DATE|30/06]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"166",text:"I","pd-insertion-point":"true"},[e("It's the last day of June so today is "),s("span",{"pd-shadow-id":"168","pd-instant":"false",text:"",class:"promptdown-var color-purple"},[s("span",{"pd-shadow-id":"169",text:"D",class:"promptdown-var-name"},"DATE"),e("30/06")]),e(`
`)])])],-1),b=a(`<div class="tip custom-block"><p class="custom-block-title">PREVIEW FEATURE</p><p><code>REGEX</code> constraints are currently in preview, which means that they may not function as expected in all cases. If you encounter problems, please report them in LMQL&#39;s issue tracker on GitHub.</p></div><h3 id="combining-constraints" tabindex="-1">Combining Constraints <a class="header-anchor" href="#combining-constraints" aria-label="Permalink to &quot;Combining Constraints&quot;">​</a></h3><p>Several constraints can be combined with the <code>and</code> and <code>or</code> keywords, recovering a Python boolean expression over the variables utilized in the LMQL query.</p><p>For example, the following program uses, both, a token length constraint and a stopping condition, to generate a short story:</p><div class="language-lmql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lmql</span><pre class="hljs"><code><span class="line"><span class="hljs-string">&quot;A story about life:<span class="hljs-placeholder">[STORY]</span>&quot;</span> \\
   <span class="hljs-keyword">where</span> STOPS_AT(STORY, <span class="hljs-string">&quot;.&quot;</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(TOKENS(STORY)) &gt; <span class="hljs-number">40</span>
</span></code></pre></div>`,5),f=s("div",{class:"language-promptdown vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"promptdown"),s("pre",{"pd-text":`A story about life:

[STORY(color=yellow)|Life is a journey filled with ups and downs, twists and turns, and unexpected surprises. It is a story that is unique to each individual, with its own set of challenges and triumphs.

For some, life begins with a loving family and a comfortable home, while for others it may start with struggle and hardship.]
`,animate:"true",__animate:"true","animate-speed":"50",class:"promptdown promptdown-compiled",style:{opacity:"1"}},[s("p",{"pd-shadow-id":"175",text:"A","pd-insertion-point":"true"},[e(`A story about life:

`),s("span",{"pd-shadow-id":"177","pd-instant":"false",text:"",class:"promptdown-var color-ochre"},[s("span",{"pd-shadow-id":"178",text:"S",class:"promptdown-var-name"},"STORY"),e(`Life is a journey filled with ups and downs, twists and turns, and unexpected surprises. It is a story that is unique to each individual, with its own set of challenges and triumphs.

For some, life begins with a loving family and a comfortable home, while for others it may start with struggle and hardship.`)]),e(`
`)])])],-1),T=a('<p>Here, we enforce a stopping condition on the <code>.</code> character, but only once the generated story is at least 40 tokens long. Thus, the interpretation of <code>and</code> with stopping conditions is that the stopping condition is only enforced once the other constraints are satisfied.</p><h2 id="how-do-lmql-constraints-work" tabindex="-1">How Do LMQL Constraints Work? <a class="header-anchor" href="#how-do-lmql-constraints-work" aria-label="Permalink to &quot;How Do LMQL Constraints Work?&quot;">​</a></h2><p><strong>Token Masking and Eager Validation</strong> LMQL constraints are evaluated eagerly on each generated token, and will be used by the runtime to generate token masks during generation. This means, that the provided constraints are either satisfied by directly guiding the model during generation appropriately or, if this is not possible, validation will fail early on during generation, saving the cost of generating invalid output. In case of greedy decoding (<code>sample</code> or <code>argmax</code>), this terminates the generation process, in case of branching decoding, it will prune the current branch and continue generation only in the remaining, valid branches.</p><p><strong>High-Level Text Constraints</strong> Constraints are high-level and operate on a text (not token) level. For instance, users can specify constraints like <code>VAR in [&quot;Hello&quot;, &quot;Hi&quot;, &quot;Greetings&quot;]</code>, without having to consider the exact tokenization of the individual phrases. LMQL will automatically translate these constraints to token masks, that can be used to guide the model during generation, allowing to generate output that satisfies the provided constraint using one generation call only.</p><h3 id="custom-constraints-and-theoretical-background" tabindex="-1">Custom Constraints and Theoretical Background <a class="header-anchor" href="#custom-constraints-and-theoretical-background" aria-label="Permalink to &quot;Custom Constraints and Theoretical Background&quot;">​</a></h3><p>To learn more about the internals of LMQL and how to implement your own LMQL constraint, see the chapter on <a href="./constraints/custom-constraints.html">Implementing Custom LMQL Constraints</a>.</p>',6),y=[r,l,p,d,c,h,u,m,g,w,_,v,b,f,T];function x(q,k,S,C,j,I){return n(),o("div",null,y)}const G=t(i,[["render",x]]);export{A as __pageData,G as default};
